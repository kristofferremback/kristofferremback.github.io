---
import { getCollection, render } from 'astro:content';
import RecipeLayout from '../../layouts/RecipeLayout.astro';
import { calculateRecipeMacros, isSectioned } from '../../lib/macros';

export async function getStaticPaths() {
	const recipes = await getCollection('recipes');
	return recipes
		.filter((recipe) => !recipe.data.draft)
		.map((recipe) => ({ params: { id: recipe.id }, props: { recipe } }));
}

const { recipe } = Astro.props;
const { Content, headings } = await render(recipe);

const { perServing, resolved } = calculateRecipeMacros(
	recipe.data.ingredients,
	recipe.data.servings
);

import type { ResolvedIngredient } from '../../lib/macros';

const toDisplay = (r: ResolvedIngredient) => ({
	name: r.name,
	amount: r.amount,
	unit: r.unit,
	gPerDl: r.gPerDl,
	macros: r.macros,
});

const ingredients = isSectioned(resolved)
	? {
			sections: resolved.sections.map((s) => ({
				name: s.name,
				ingredients: s.ingredients.map(toDisplay),
			})),
		}
	: resolved.map(toDisplay);
---

<RecipeLayout
	id={recipe.id}
	title={recipe.data.title}
	description={recipe.data.description}
	prepTime={recipe.data.prepTime}
	cookTime={recipe.data.cookTime}
	servings={recipe.data.servings}
	macros={perServing}
	ingredients={ingredients}
	tags={recipe.data.tags}
	headings={headings}
	recipeBody={recipe.body}
>
	<Content />
</RecipeLayout>
