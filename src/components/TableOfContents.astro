---
interface Heading {
	depth: number;
	slug: string;
	text: string;
}

interface Props {
	headings: Heading[];
}

const { headings } = Astro.props;
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);

function cleanHeadingText(text: string): string {
	return text.replace(/^#\s*/, '');
}
---

{tocHeadings.length > 0 && (
	<nav class="toc hidden xl:block fixed top-0 right-0 h-screen w-56 pt-32 pr-8" aria-label="Table of contents">
		<div class="sticky top-32">
			<h2 class="text-xs font-semibold uppercase tracking-wider text-stone-500 dark:text-stone-400 mb-3">
				On this page
			</h2>
			<ul class="space-y-2 text-sm border-l border-stone-200 dark:border-stone-800">
				{tocHeadings.map((heading) => (
					<li>
						<a
							href={`#${heading.slug}`}
							class:list={[
								'toc-link block py-1 transition-colors border-l -ml-px',
								heading.depth === 3 ? 'pl-6' : 'pl-4',
							]}
							data-slug={heading.slug}
						>
							{cleanHeadingText(heading.text)}
						</a>
					</li>
				))}
			</ul>
			<a
				href="#"
				class="back-to-top mt-6 block text-sm text-stone-400 dark:text-stone-500 hover:text-stone-600 dark:hover:text-stone-300 transition-colors opacity-0 pointer-events-none"
				aria-label="Back to top"
			>
				&uarr; Back to top
			</a>
		</div>
	</nav>
)}

<script is:inline>
	(function () {
		const tocLinks = document.querySelectorAll('.toc-link');
		const backToTop = document.querySelector('.back-to-top');
		if (tocLinks.length === 0) return;

		const headingIds = Array.from(tocLinks).map((link) => link.dataset.slug);
		const headings = headingIds
			.map((id) => document.getElementById(id))
			.filter(Boolean);

		if (headings.length === 0) return;

		let activeId = null;

		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						activeId = entry.target.id;
						updateActiveLink();
					}
				});
			},
			{
				rootMargin: '-80px 0px -70% 0px',
				threshold: 0,
			}
		);

		headings.forEach((heading) => observer.observe(heading));

		function updateActiveLink() {
			tocLinks.forEach((link) => {
				const isActive = link.dataset.slug === activeId;
				link.classList.toggle('text-stone-900', isActive);
				link.classList.toggle('dark:text-stone-100', isActive);
				link.classList.toggle('border-stone-900', isActive);
				link.classList.toggle('dark:border-stone-100', isActive);
				link.classList.toggle('text-stone-400', !isActive);
				link.classList.toggle('dark:text-stone-500', !isActive);
				link.classList.toggle('border-transparent', !isActive);
			});
		}

		// Smooth scroll on click
		tocLinks.forEach((link) => {
			link.addEventListener('click', (e) => {
				e.preventDefault();
				const target = document.getElementById(link.dataset.slug);
				if (target) {
					target.scrollIntoView({ behavior: 'smooth', block: 'start' });
					history.pushState(null, '', `#${link.dataset.slug}`);
				}
			});
		});

		// Back to top
		if (backToTop) {
			backToTop.addEventListener('click', (e) => {
				e.preventDefault();
				window.scrollTo({ top: 0, behavior: 'smooth' });
				history.pushState(null, '', window.location.pathname);
			});

			window.addEventListener('scroll', () => {
				const show = window.scrollY > 400;
				backToTop.classList.toggle('opacity-0', !show);
				backToTop.classList.toggle('pointer-events-none', !show);
				backToTop.classList.toggle('opacity-100', show);
				backToTop.classList.toggle('pointer-events-auto', show);
			}, { passive: true });
		}

		// Set initial active based on hash or first heading
		if (window.location.hash) {
			activeId = window.location.hash.slice(1);
		} else if (headings[0]) {
			activeId = headings[0].id;
		}
		updateActiveLink();
	})();
</script>
