---
import { PortionCalculator } from './PortionCalculator';
import { IngredientAmount } from './IngredientAmount';
import { IngredientMacros } from './IngredientMacros';

interface Macros {
	calories: number;
	protein: number;
	carbs: number;
	fat: number;
	fiber: number;
}

interface Ingredient {
	name: string;
	amount: number;
	unit: string;
	gPerDl?: number;
	macros?: Macros;
	notes?: string;
}

interface Section {
	name: string;
	ingredients: Ingredient[];
}

type Ingredients = Ingredient[] | { sections: Section[] };

interface Props {
	servings: number;
	ingredients: Ingredients;
	macros: Macros;
}

const { servings, ingredients, macros } = Astro.props;

const isSectioned = 'sections' in ingredients;
const flatIngredients = isSectioned
	? ingredients.sections.flatMap((s) => s.ingredients)
	: ingredients;

let ingredientIndex = 0;
---

<div id="portion-calculator" class="grid md:grid-cols-[1fr_1.2fr] gap-8">
	<!-- Left column: macros + servings -->
	<PortionCalculator
		baseServings={servings}
		ingredients={flatIngredients.map((i) => ({ name: i.name, amount: i.amount, unit: i.unit }))}
		macros={macros}
		client:load
	/>

	<!-- Right column: ingredients -->
	<div>
		<h3 id="ingredients-heading" class="text-sm font-bold uppercase tracking-wider text-stone-500 dark:text-stone-400 mb-5">Ingredients</h3>
		{isSectioned ? (
			<div id="ingredients-list" class="space-y-6">
				{ingredients.sections.map((section) => (
					<div>
						<h4 class="text-xs font-semibold uppercase tracking-wider text-stone-400 dark:text-stone-500 mb-2">{section.name}</h4>
						<ul class="divide-y divide-stone-100 dark:divide-stone-800/50">
							{section.ingredients.map((ing) => {
								const idx = ingredientIndex++;
								return (
									<li class="flex items-center justify-between py-2.5">
										<span class="text-sm flex items-center gap-1.5">
											{ing.name}
											{ing.macros && (
												<IngredientMacros macros={ing.macros} baseServings={servings} notes={ing.notes} client:load />
											)}
										</span>
										<IngredientAmount
											amount={ing.amount}
											unit={ing.unit}
											gPerDl={ing.gPerDl}
											index={idx}
											client:load
										/>
									</li>
								);
							})}
						</ul>
					</div>
				))}
			</div>
		) : (
			<ul id="ingredients-list" class="divide-y divide-stone-100 dark:divide-stone-800/50">
				{ingredients.map((ing) => {
					const idx = ingredientIndex++;
					return (
						<li class="flex items-center justify-between py-2.5">
							<span class="text-sm flex items-center gap-1.5">
								{ing.name}
								{ing.macros && (
									<IngredientMacros macros={ing.macros} baseServings={servings} notes={ing.notes} client:load />
								)}
							</span>
							<IngredientAmount
								amount={ing.amount}
								unit={ing.unit}
								gPerDl={ing.gPerDl}
								index={idx}
								client:load
							/>
						</li>
					);
				})}
			</ul>
		)}
	</div>
</div>
