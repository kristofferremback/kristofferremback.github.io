---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const posts = (await getCollection('blog'))
	.filter((post) => !post.data.draft)
	.sort((a, b) => {
		const dateCompare = b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
		if (dateCompare !== 0) return dateCompare;
		return a.data.title.localeCompare(b.data.title);
	});

const rendered = await Promise.all(
	posts.map(async (post) => ({
		post,
		Content: (await render(post)).Content,
	}))
);

const TRUNCATE_THRESHOLD = 1200;
---

<BaseLayout title="Kristoffer Remback">
	<section class="space-y-16">
		{rendered.map(({ post, Content }) => {
			const isLong = (post.body?.length ?? 0) > TRUNCATE_THRESHOLD;
			const dateStr = post.data.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
			return (
				<article transition:name={`post-${post.id}`}>
					<header class="mb-6">
						<div class="flex items-baseline justify-between gap-4">
							<h2 class="text-2xl font-bold tracking-tight">
								<a href={`/blog/${post.id}`} class="hover:text-stone-500 dark:hover:text-stone-400 transition-colors">
									{post.data.title}
								</a>
							</h2>
							<time class="text-sm text-stone-500 dark:text-stone-400 shrink-0 tabular-nums" datetime={post.data.pubDate.toISOString()}>
								{dateStr}
							</time>
						</div>
						{post.data.tags.length > 0 && (
							<div class="mt-2 flex gap-2">
								{post.data.tags.map((tag) => (
									<a
										href={`/tags/${tag}`}
										class="text-xs px-2 py-0.5 rounded-full bg-stone-200 text-stone-600 hover:bg-stone-300 dark:bg-stone-800 dark:text-stone-400 dark:hover:bg-stone-700 transition-colors"
									>
										{tag}
									</a>
								))}
							</div>
						)}
					</header>

					<div class={`prose dark:prose-invert max-w-none ${isLong ? 'post-truncated' : ''}`}>
						<Content />
					</div>

					{isLong && (
						<a
							href={`/blog/${post.id}`}
							class="inline-block mt-4 text-sm font-medium text-stone-500 hover:text-stone-900 dark:text-stone-400 dark:hover:text-stone-100 transition-colors"
						>
							Continue reading &rarr;
						</a>
					)}
				</article>
			);
		})}
	</section>
	{posts.length === 0 && (
		<p class="text-stone-500 dark:text-stone-400">No posts yet.</p>
	)}
</BaseLayout>
